<!DOCTYPE html>    <html>  <head>    <title>pages.js</title>    <meta http-equiv="content-type" content="text/html; charset=UTF-8">    <link rel="stylesheet" media="all" href="../docco.css" />  </head>  <body>    <div id="container">      <div id="background"></div>              <div id="jump_to">          Jump To &hellip;          <div id="jump_wrapper">            <div id="jump_page">                                              <a class="source" href="../config.html">                  config.html                </a>                                              <a class="source" href="../ext/github.html">                  ext/github.html                </a>                                              <a class="source" href="../ext/json.html">                  ext/json.html                </a>                                              <a class="source" href="../ext/pages.html">                  ext/pages.html                </a>                                              <a class="source" href="../model/posts.html">                  model/posts.html                </a>                                              <a class="source" href="../node-yabe.html">                  node-yabe.html                </a>                                              <a class="source" href="../renderer.html">                  renderer.html                </a>                                              <a class="source" href="../routes.html">                  routes.html                </a>                                              <a class="source" href="../util.html">                  util.html                </a>                          </div>          </div>        </div>            <table cellpadding="0" cellspacing="0">        <thead>          <tr>            <th class="docs">              <h1>                pages.js              </h1>            </th>            <th class="code">            </th>          </tr>        </thead>        <tbody>                                  <tr id="section-1">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-1">&#182;</a>                </div>                              </td>              <td class="code">                <div class="highlight"><pre><span class="kwd">var</span><span class="pln"> connect </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'connect'</span><span class="pun">),</span><span class="pln"><br />fs </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">),</span><span class="pln"><br />jqtpl </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'node-jqtpl'</span><span class="pun">),</span><span class="pln"><br />prettify </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'prettify'</span><span class="pun">),</span><span class="pln"><br />config </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'../config'</span><span class="pun">),</span><span class="pln"><br />routes </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'../routes'</span><span class="pun">),</span><span class="pln"><br />renderer </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'../renderer'</span><span class="pun">),</span><span class="pln"><br /><br />yaml </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'yaml'</span><span class="pun">),</span><span class="pln"><br /><br />path </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">process</span><span class="pun">.</span><span class="pln">cwd</span><span class="pun">(),</span><span class="pln"> config</span><span class="pun">.</span><span class="pln">themeDir</span><span class="pun">,</span><span class="pln"> config</span><span class="pun">.</span><span class="pln">theme</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">].</span><span class="pln">join</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">),</span><span class="pln"><br /><br />extend </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> extend</span><span class="pun">(</span><span class="pln">obj</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="typ">Array</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">slice</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">arguments</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">).</span><span class="pln">forEach</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">source</span><span class="pun">){</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> prop </span><span class="kwd">in</span><span class="pln"> source</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">source</span><span class="pun">[</span><span class="pln">prop</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!==</span><span class="pln"> </span><span class="kwd">undefined</span><span class="pun">)</span><span class="pln"> obj</span><span class="pun">[</span><span class="pln">prop</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> source</span><span class="pun">[</span><span class="pln">prop</span><span class="pun">];</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">return</span><span class="pln"> obj</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span><span class="kwd">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> json</span><span class="pun">(</span><span class="pln">o</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; <br />&nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">'init pages layer &gt; '</span><span class="pun">,</span><span class="pln"> o</span><span class="pun">);</span><span class="pln"><br />&nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-2">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-2">&#182;</a>                </div>                <p>todo better merge in
and dryer... a lot of code is being duplicated (syntax highlight, ...)</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; fs</span><span class="pun">.</span><span class="pln">readFile</span><span class="pun">(</span><span class="pln">path </span><span class="pun">+</span><span class="pln"> </span><span class="str">'config.yml'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> body</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="kwd">throw</span><span class="pln"> err</span><span class="pun">;}</span><span class="pln"><br />&nbsp; &nbsp; <br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> data </span><span class="pun">=</span><span class="pln"> yaml</span><span class="pun">.</span><span class="kwd">eval</span><span class="pun">(</span><span class="pln">body</span><span class="pun">.</span><span class="pln">toString</span><span class="pun">());</span><span class="pln"><br />&nbsp; &nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-3">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-3">&#182;</a>                </div>                <p>merge in global config with templates one
this is a module-scoped singleton</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; &nbsp; config </span><span class="pun">=</span><span class="pln"> extend</span><span class="pun">({},</span><span class="pln"> config</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">return</span><span class="pln"> connect</span><span class="pun">.</span><span class="pln">router</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">app</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; <br />&nbsp; &nbsp; app</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'/:file'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> url </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="pln">url</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; file </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">file</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; tmplKey </span><span class="pun">=</span><span class="pln"> </span><span class="str">'tmpl.page.{file}.html'</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">(</span><span class="str">'{file}'</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">),</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; hasTmpl </span><span class="pun">=</span><span class="pln"> jqtpl</span><span class="pun">.</span><span class="kwd">template</span><span class="pun">[</span><span class="pln">tmplKey</span><span class="pun">],</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; layout</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">hasTmpl</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">();</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; data </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln">headers</span><span class="pun">:</span><span class="pln"> req</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">,</span><span class="pln"> config</span><span class="pun">:</span><span class="pln"> config</span><span class="pun">,</span><span class="pln"> context</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{},</span><span class="pln"> content</span><span class="pun">:</span><span class="pln"> jqtpl</span><span class="pun">.</span><span class="pln">tmpl</span><span class="pun">(</span><span class="pln">tmplKey</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">config</span><span class="pun">:</span><span class="pln"> config</span><span class="pun">})};</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; renderer</span><span class="pun">.</span><span class="pln">emit</span><span class="pun">(</span><span class="str">'yabe.render'</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">res</span><span class="pun">.</span><span class="pln">finished</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="kwd">return</span><span class="pun">;}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; layout </span><span class="pun">=</span><span class="pln"> jqtpl</span><span class="pun">.</span><span class="pln">tmpl</span><span class="pun">(</span><span class="str">'tmpl.layout.html'</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-4">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-4">&#182;</a>                </div>                <p>prettify snippets of code</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; &nbsp; &nbsp; &nbsp; layout </span><span class="pun">=</span><span class="pln"> layout</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">(</span><span class="str">/</span><pre><code><span class="str">[^&lt;]+&lt;\/code&gt;&lt;\/pre&gt;/</span><span class="pln">g</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">code</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; code </span><span class="pun">=</span><span class="pln"> code</span><span class="pun">.</span><span class="pln">match</span><span class="pun">(</span><span class="str">/</span><code><span class="str">([\s\S]+)&lt;\/code&gt;/</span><span class="pun">)[</span><span class="lit">1</span><span class="pun">];</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; code </span><span class="pun">=</span><span class="pln"> prettify</span><span class="pun">.</span><span class="pln">prettyPrintOne</span><span class="pun">(</span><span class="pln">code</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="str">"</span><pre><code><span class="str">"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> code </span><span class="pun">+</span><span class="pln"> </span><span class="str">"</span></code></pre><span class="str">"</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'Content-Type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'text/html'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="str">'Content-Length'</span><span class="pun">:</span><span class="pln"> layout</span><span class="pun">.</span><span class="pln">length<br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">(</span><span class="pln">layout</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; <br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /></span></pre></div>              </td>            </tr>                  </tbody>      </table>    </div>  </body>  </html>