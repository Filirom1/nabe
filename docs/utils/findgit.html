<!DOCTYPE html>    <html>  <head>    <title>findgit.js</title>    <meta http-equiv="content-type" content="text/html; charset=UTF-8">    <link rel="stylesheet" media="all" href="../docco.css" />  </head>  <body>    <div id="container">      <div id="background"></div>              <div id="jump_to">          Jump To &hellip;          <div id="jump_wrapper">            <div id="jump_page">                                              <a class="source" href="../config.html">                  config.html                </a>                                              <a class="source" href="../ext/github.html">                  ext/github.html                </a>                                              <a class="source" href="../ext/json.html">                  ext/json.html                </a>                                              <a class="source" href="../ext/pages.html">                  ext/pages.html                </a>                                              <a class="source" href="../model/posts.html">                  model/posts.html                </a>                                              <a class="source" href="../nabe.html">                  nabe.html                </a>                                              <a class="source" href="../renderer.html">                  renderer.html                </a>                                              <a class="source" href="../routes.html">                  routes.html                </a>                                              <a class="source" href="../utils/findgit.html">                  utils/findgit.html                </a>                                              <a class="source" href="../utils/git.html">                  utils/git.html                </a>                                              <a class="source" href="../utils/util.html">                  utils/util.html                </a>                          </div>          </div>        </div>            <table cellpadding="0" cellspacing="0">        <thead>          <tr>            <th class="docs">              <h1>                findgit.js              </h1>            </th>            <th class="code">            </th>          </tr>        </thead>        <tbody>                                  <tr id="section-1">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-1">&#182;</a>                </div>                              </td>              <td class="code">                <div class="highlight"><pre><span class="kwd">var</span><span class="pln"> </span><span class="typ">Git</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'git-fs'</span><span class="pun">),</span><span class="pln"><br /></span><span class="typ">Path</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'path'</span><span class="pun">),</span><span class="pln"><br />events </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'events'</span><span class="pun">);</span><span class="pln"><br /><br />exports</span><span class="pun">.</span><span class="pln">find </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> findgit</span><span class="pun">(</span><span class="pln">abspath</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[],</span><span class="pln"> dirs </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[],</span><span class="pln"> count </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"><br />&nbsp; em </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> events</span><span class="pun">.</span><span class="typ">EventEmitter</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; <br />&nbsp; </span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> recurse</span><span class="pun">(</span><span class="pln">p</span><span class="pun">,</span><span class="pln"> f</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; <br />&nbsp; &nbsp; </span><span class="typ">Git</span><span class="pun">.</span><span class="pln">readDir</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">,</span><span class="pln"> p</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> results</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> callback </span><span class="pun">?</span><span class="pln"> callback</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[])</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> em</span><span class="pun">.</span><span class="pln">emit</span><span class="pun">(</span><span class="str">'error'</span><span class="pun">,</span><span class="pln"> err</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[]);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> d </span><span class="pun">=</span><span class="pln"> results</span><span class="pun">.</span><span class="pln">dirs<br />&nbsp; &nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">q</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> q </span><span class="pun">!==</span><span class="pln"> </span><span class="str">'.git'</span><span class="pun">;</span><span class="pln"> </span><span class="pun">})</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">a</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> dir </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">p</span><span class="pun">,</span><span class="pln"> a</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; em</span><span class="pun">.</span><span class="pln">emit</span><span class="pun">(</span><span class="str">'directory'</span><span class="pun">,</span><span class="pln"> dir</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> dir</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}),</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; f </span><span class="pun">=</span><span class="pln"> results</span><span class="pun">.</span><span class="pln">files</span><span class="pun">.</span><span class="pln">map</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">a</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> file </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Path</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="pln">p</span><span class="pun">,</span><span class="pln"> a</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; em</span><span class="pun">.</span><span class="pln">emit</span><span class="pun">(</span><span class="str">'file'</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> file</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"> &nbsp; <br />&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; files </span><span class="pun">=</span><span class="pln"> files</span><span class="pun">.</span><span class="pln">concat</span><span class="pun">(</span><span class="pln">f</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; dirs </span><span class="pun">=</span><span class="pln"> dirs</span><span class="pun">.</span><span class="pln">concat</span><span class="pun">(</span><span class="pln">d</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-2">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-2">&#182;</a>                </div>                <p>if we have dirs, recurse</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; &nbsp; &nbsp; d</span><span class="pun">.</span><span class="pln">forEach</span><span class="pun">(</span><span class="pln">recurse</span><span class="pun">);</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-3">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-3">&#182;</a>                </div>                <p>incr count so that we know where we are</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; &nbsp; &nbsp; count</span><span class="pun">++;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-4">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-4">&#182;</a>                </div>                <p>if no dir to work with, return callback
also make sure we're done with all dirs</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">d</span><span class="pun">.</span><span class="pln">length </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dirs</span><span class="pun">.</span><span class="pln">length </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">===</span><span class="pln"> count</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> callback </span><span class="pun">?</span><span class="pln"> callback</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">files</span><span class="pun">:</span><span class="pln"> files</span><span class="pun">,</span><span class="pln"> dirs</span><span class="pun">:</span><span class="pln"> dirs</span><span class="pun">})</span><span class="pln"> </span><span class="pun">:</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; em</span><span class="pun">.</span><span class="pln">emit</span><span class="pun">(</span><span class="str">'end'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">files</span><span class="pun">:</span><span class="pln"> files</span><span class="pun">,</span><span class="pln"> dirs</span><span class="pun">:</span><span class="pln"> dirs</span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">})(</span><span class="pln">abspath</span><span class="pun">);</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">return</span><span class="pln"> em</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /></span></pre></div>              </td>            </tr>                  </tbody>      </table>    </div>  </body>  </html>