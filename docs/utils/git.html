<!DOCTYPE html>    <html>  <head>    <title>git.js</title>    <meta http-equiv="content-type" content="text/html; charset=UTF-8">    <link rel="stylesheet" media="all" href="../docco.css" />  </head>  <body>    <div id="container">      <div id="background"></div>              <div id="jump_to">          Jump To &hellip;          <div id="jump_wrapper">            <div id="jump_page">                                              <a class="source" href="../config.html">                  config.html                </a>                                              <a class="source" href="../ext/github.html">                  ext/github.html                </a>                                              <a class="source" href="../ext/json.html">                  ext/json.html                </a>                                              <a class="source" href="../ext/pages.html">                  ext/pages.html                </a>                                              <a class="source" href="../model/posts.html">                  model/posts.html                </a>                                              <a class="source" href="../nabe.html">                  nabe.html                </a>                                              <a class="source" href="../renderer.html">                  renderer.html                </a>                                              <a class="source" href="../routes.html">                  routes.html                </a>                                              <a class="source" href="../utils/findgit.html">                  utils/findgit.html                </a>                                              <a class="source" href="../utils/git.html">                  utils/git.html                </a>                                              <a class="source" href="../utils/util.html">                  utils/util.html                </a>                          </div>          </div>        </div>            <table cellpadding="0" cellspacing="0">        <thead>          <tr>            <th class="docs">              <h1>                git.js              </h1>            </th>            <th class="code">            </th>          </tr>        </thead>        <tbody>                                  <tr id="section-1">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-1">&#182;</a>                </div>                              </td>              <td class="code">                <div class="highlight"><pre><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">),</span><span class="pln"><br /></span><span class="typ">ChildProcess</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'child_process'</span><span class="pun">),</span><span class="pln"><br />git </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'git-fs'</span><span class="pun">);</span><span class="pln"><br /><br /></span><span class="kwd">var</span><span class="pln"> gitENOENT </span><span class="pun">=</span><span class="pln"> </span><span class="str">/fatal: (Path '([^']+)' does not exist in '([0-9a-f]{40})'|ambiguous argument '([^']+)': unknown revision or path not in the working tree.)/</span><span class="pun">;</span><span class="pln"><br /><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-2">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-2">&#182;</a>                </div>                <p>helper to talk to the git subprocess, coming from git-fs (not exposed by default)</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">git</span><span class="pun">.</span><span class="kwd">exec</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="kwd">exec</span><span class="pun">(</span><span class="pln">commands</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> child </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ChildProcess</span><span class="pun">.</span><span class="pln">spawn</span><span class="pun">(</span><span class="str">"git"</span><span class="pun">,</span><span class="pln"> commands</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> stdout </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[],</span><span class="pln"> stderr </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[];</span><span class="pln"><br />&nbsp; child</span><span class="pun">.</span><span class="pln">stdout</span><span class="pun">.</span><span class="pln">setEncoding</span><span class="pun">(</span><span class="str">'binary'</span><span class="pun">);</span><span class="pln"><br />&nbsp; child</span><span class="pun">.</span><span class="pln">stdout</span><span class="pun">.</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; stdout</span><span class="pun">[</span><span class="pln">stdout</span><span class="pun">.</span><span class="pln">length</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> text</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; child</span><span class="pun">.</span><span class="pln">stderr</span><span class="pun">.</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">'data'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; stderr</span><span class="pun">[</span><span class="pln">stderr</span><span class="pun">.</span><span class="pln">length</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> text</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; child</span><span class="pun">.</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">'exit'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">code</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> </span><span class="kwd">out</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> stdout</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">''</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">code </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="kwd">out</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="str">/nothing\sto\scommit/</span><span class="pun">.</span><span class="pln">test</span><span class="pun">(</span><span class="kwd">out</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> callback</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Error</span><span class="pun">(</span><span class="str">"git "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> commands</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">" "</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="kwd">out</span><span class="pun">));</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; callback</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> stdout</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">''</span><span class="pun">));</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; child</span><span class="pun">.</span><span class="pln">stdin</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">();</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /><br />git</span><span class="pun">.</span><span class="pln">commit </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> commit</span><span class="pun">(</span><span class="pln">file</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">'Fu commit'</span><span class="pun">,</span><span class="pln"> arguments</span><span class="pun">);</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">var</span><span class="pln"> args </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'add'</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">],</span><span class="pln"><br />&nbsp; </span><span class="kwd">out</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">""</span><span class="pun">,</span><span class="pln"><br />&nbsp; </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="kwd">exec</span><span class="pun">(</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> callback</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">out</span><span class="pln"> </span><span class="pun">+=</span><span class="pln"> text</span><span class="pun">;</span><span class="pln"> &nbsp; &nbsp;<br />&nbsp; &nbsp; </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">exec</span><span class="pun">([</span><span class="str">'commit'</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-m'</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">],</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">err</span><span class="pun">.</span><span class="pln">stack</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> callback</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">out</span><span class="pln"> </span><span class="pun">+=</span><span class="pln"> text</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; callback</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">out</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br />git</span><span class="pun">.</span><span class="pln">grep </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> grep</span><span class="pun">(</span><span class="pln">term</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">where</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> args </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'grep'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-i'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'--name-only'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-E'</span><span class="pun">];</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">arguments</span><span class="pun">.</span><span class="pln">length </span><span class="pun">===</span><span class="pln"> </span><span class="lit">2</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; callback </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">where</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">where</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; <br />&nbsp; args </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">where</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> args</span><span class="pun">.</span><span class="pln">concat</span><span class="pun">(</span><span class="pln">term</span><span class="pun">,</span><span class="pln"> </span><span class="str">'--'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">where</span><span class="pun">)</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> args</span><span class="pun">.</span><span class="pln">concat</span><span class="pun">(</span><span class="pln">term</span><span class="pun">);</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="kwd">exec</span><span class="pun">(</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[];</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> callback</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(!</span><span class="pln">text</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> callback</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[]);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; <br />&nbsp; &nbsp; text</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="str">/\n|\r\n/</span><span class="pun">).</span><span class="pln">forEach</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">file</span><span class="pun">,</span><span class="pln"> i</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; files</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> file</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; <br />&nbsp; &nbsp; callback</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> files</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /></span></pre></div>              </td>            </tr>                  </tbody>      </table>    </div>  </body>  </html>