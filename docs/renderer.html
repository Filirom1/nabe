<!DOCTYPE html>    <html>  <head>    <title>renderer.js</title>    <meta http-equiv="content-type" content="text/html; charset=UTF-8">    <link rel="stylesheet" media="all" href="docco.css" />  </head>  <body>    <div id="container">      <div id="background"></div>              <div id="jump_to">          Jump To &hellip;          <div id="jump_wrapper">            <div id="jump_page">                                              <a class="source" href="config.html">                  config.html                </a>                                              <a class="source" href="model/posts.html">                  model/posts.html                </a>                                              <a class="source" href="node-yabe.html">                  node-yabe.html                </a>                                              <a class="source" href="renderer.html">                  renderer.html                </a>                                              <a class="source" href="routes.html">                  routes.html                </a>                                              <a class="source" href="util.html">                  util.html                </a>                          </div>          </div>        </div>            <table cellpadding="0" cellspacing="0">        <thead>          <tr>            <th class="docs">              <h1>                renderer.js              </h1>            </th>            <th class="code">            </th>          </tr>        </thead>        <tbody>                                  <tr id="section-1">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-1">&#182;</a>                </div>                <p>This file is the main application controller; it is loaded and used by the <a href="routes.html">router</a> module. </p>

<p>Generally, this file should be used only for defining actions and methods
should follow the <code>.method(req, res, next)</code> pattern.</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="kwd">var</span><span class="pln"> fs </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'fs'</span><span class="pun">),</span><span class="pln"><br />sys </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'sys'</span><span class="pun">),</span><span class="pln"><br />yaml </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'yaml'</span><span class="pun">),</span><span class="pln"><br />findit </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'findit'</span><span class="pun">),</span><span class="pln"><br />events </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'events'</span><span class="pun">),</span><span class="pln"><br /><br />config </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'./config'</span><span class="pun">),</span><span class="pln"><br />util </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'./util'</span><span class="pun">),</span><span class="pln"><br />posts </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'./model/posts'</span><span class="pun">),</span><span class="pln"><br /><br />path </span><span class="pun">=</span><span class="pln"> process</span><span class="pun">.</span><span class="pln">cwd</span><span class="pun">();</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-2">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-2">&#182;</a>                </div>                <h2>Renderer</h2>

<p>Main actions(controllers) go here. renderers are instance of 
EventEmitter to provide a set of response lifecycle hooks.</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="kwd">var</span><span class="pln"> </span><span class="typ">Renderer</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="typ">Renderer</span><span class="pun">(</span><span class="pln">o</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> dir </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> o</span><span class="pun">.</span><span class="pln">themeDir</span><span class="pun">,</span><span class="pln"> o</span><span class="pun">.</span><span class="pln">theme</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">].</span><span class="pln">join</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">),</span><span class="pln"><br />&nbsp; pages </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[];</span><span class="pln"><br />&nbsp; <br />&nbsp; events</span><span class="pun">.</span><span class="typ">EventEmitter</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-3">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-3">&#182;</a>                </div>                <p>add each templates found in <code>themeDir/theme/templates/pages</code></p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; findit</span><span class="pun">.</span><span class="pln">find</span><span class="pun">(</span><span class="pln">dir </span><span class="pun">+</span><span class="pln"> </span><span class="str">'templates'</span><span class="pun">)</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="str">'file'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file</span><span class="pun">,</span><span class="pln"> stat</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln"> </span><span class="pun">!(/\.</span><span class="pln">html</span><span class="pun">|\.</span><span class="pln">xml</span><span class="pun">/.</span><span class="pln">test</span><span class="pun">(</span><span class="pln">file</span><span class="pun">))</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; pages</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">file</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">})</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="str">'end'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="kwd">end</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; pages</span><span class="pun">.</span><span class="pln">forEach</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">page</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; util</span><span class="pun">.</span><span class="pln">addTemplate</span><span class="pun">(</span><span class="pln">page</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-4">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-4">&#182;</a>                </div>                <p>merge in <code>config.yml</code> settings,
since init is call on server startup sync is ok there</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">options </span><span class="pun">=</span><span class="pln"> util</span><span class="pun">.</span><span class="pln">extend</span><span class="pun">({},</span><span class="pln"> config</span><span class="pun">,</span><span class="pln"> yaml</span><span class="pun">.</span><span class="kwd">eval</span><span class="pun">(</span><span class="pln">fs</span><span class="pun">.</span><span class="pln">readFileSync</span><span class="pun">(</span><span class="pln">dir </span><span class="pun">+</span><span class="pln"> </span><span class="str">'config.yml'</span><span class="pun">).</span><span class="pln">toString</span><span class="pun">()));</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br />sys</span><span class="pun">.</span><span class="pln">inherits</span><span class="pun">(</span><span class="typ">Renderer</span><span class="pun">,</span><span class="pln"> events</span><span class="pun">.</span><span class="typ">EventEmitter</span><span class="pun">);</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-5">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-5">&#182;</a>                </div>                <h3>.index(req, res, next, cb)</h3>

<p>main action, called on <code>/</code>, display a list of articles sorted by most recent one</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="typ">Renderer</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">index </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> index</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">,</span><span class="pln"> cb</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> abspath </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">options</span><span class="pun">.</span><span class="pln">articleDir</span><span class="pun">].</span><span class="pln">join</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">).</span><span class="pln">replace</span><span class="pun">(</span><span class="str">/\/$/</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">),</span><span class="pln"><br />&nbsp; </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">cb </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="kwd">typeof</span><span class="pln"> cb </span><span class="pun">===</span><span class="pln"> </span><span class="str">'function'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-6">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-6">&#182;</a>                </div>                <p>we're given a specific abspath, defaults to default behaviour</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; &nbsp; abspath </span><span class="pun">=</span><span class="pln"> cb</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; cb </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span><span class="pln"><br />&nbsp; </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; posts</span><span class="pun">.</span><span class="pln">all</span><span class="pun">(</span><span class="pln">abspath</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> results</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">render</span><span class="pun">(</span><span class="str">'index.html'</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; articles</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; headers</span><span class="pun">:</span><span class="pln"> req</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; config</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">options<br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-7">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-7">&#182;</a>                </div>                <h3>.category(req, res, next)</h3>

<p>category action, called on <code>category/folder/or/subfolder</code>
display a list of articles sorted by most recent one, and filtered by corresponding path</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="typ">Renderer</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">category </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> category</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> abspath </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">options</span><span class="pun">.</span><span class="pln">articleDir</span><span class="pun">].</span><span class="pln">join</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">).</span><span class="pln">replace</span><span class="pun">(</span><span class="str">/\/$/</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">),</span><span class="pln"><br />&nbsp; filter </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">category </span><span class="pun">||</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">,</span><span class="pln"><br />&nbsp; </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br />&nbsp; <br />&nbsp; posts</span><span class="pun">.</span><span class="pln">categories</span><span class="pun">(</span><span class="pln">abspath</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">RegExp</span><span class="pun">(</span><span class="str">'/'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> filter </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">),</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> results</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">render</span><span class="pun">(</span><span class="str">'index.html'</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; articles</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; headers</span><span class="pun">:</span><span class="pln"> req</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; config</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">options<br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-8">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-8">&#182;</a>                </div>                <h3>.tag(req, res, next)</h3>

<p>tag action, called on <code>tag/tag-name</code>
display a list of articles sorted by most recent one, and filtered by corresponding tag</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="typ">Renderer</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">tag </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> tag</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> abspath </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">options</span><span class="pun">.</span><span class="pln">articleDir</span><span class="pun">].</span><span class="pln">join</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">).</span><span class="pln">replace</span><span class="pun">(</span><span class="str">/\/$/</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">),</span><span class="pln"><br />&nbsp; filter </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">RegExp</span><span class="pun">(</span><span class="str">'/'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">category </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">),</span><span class="pln"><br />&nbsp; </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br />&nbsp; <br />&nbsp; posts</span><span class="pun">.</span><span class="pln">tags</span><span class="pun">(</span><span class="pln">abspath</span><span class="pun">,</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">.</span><span class="pln">tag</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> results</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">render</span><span class="pun">(</span><span class="str">'index.html'</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; articles</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; headers</span><span class="pun">:</span><span class="pln"> req</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; config</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">options<br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-9">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-9">&#182;</a>                </div>                <h3>.article(req, res, next)</h3>

<p>article action, called on <code>/article/article-name</code> or <code>/article/folder/or/subfolder/article-name</code>
display an article content along metadata informations and git revisions.</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="typ">Renderer</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">article </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> article </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"><br />&nbsp; abspath </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">options</span><span class="pun">.</span><span class="pln">articleDir</span><span class="pun">,</span><span class="pln"> article</span><span class="pun">].</span><span class="pln">join</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">).</span><span class="pln">replace</span><span class="pun">(</span><span class="str">/\/$/</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">),</span><span class="pln"><br />&nbsp; mkdpath </span><span class="pun">=</span><span class="pln"> abspath </span><span class="pun">+</span><span class="pln"> </span><span class="str">'.markdown'</span><span class="pun">,</span><span class="pln"><br />&nbsp; </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-10">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-10">&#182;</a>                </div>                <p>if it's a valid dir, serves its files</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; fs</span><span class="pun">.</span><span class="pln">stat</span><span class="pun">(</span><span class="pln">mkdpath</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> stat</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-11">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-11">&#182;</a>                </div>                <p>before returning error, try to redirect on category 
users had most likely hit something like <code>articles/path/</code> instead of <code>articles/path/post-name</code></p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">category</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">stat</span><span class="pun">.</span><span class="pln">isDirectory</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">index</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">,</span><span class="pln"> abspath</span><span class="pun">);}</span><span class="pln"><br />&nbsp; &nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-12">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-12">&#182;</a>                </div>                <p>otherwise, proceed normally</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; &nbsp; posts</span><span class="pun">.</span><span class="pln">find</span><span class="pun">(</span><span class="pln">abspath </span><span class="pun">+</span><span class="pln"> </span><span class="str">'.markdown'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> results</span><span class="pun">){</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">render</span><span class="pun">(</span><span class="str">'article.html'</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; article</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; author</span><span class="pun">:</span><span class="pln"> &nbsp;</span><span class="pun">{</span><span class="pln">name</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">.</span><span class="pln">author</span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; headers</span><span class="pun">:</span><span class="pln"> req</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; content</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">.</span><span class="pln">body</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; config</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">options<br />&nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-13">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-13">&#182;</a>                </div>                <h3>.revision(req, res, next)</h3>

<p>revision action, called on <code>e3e43764c7854f5ce4c16d527ec6244a3c2a0f7d/article-name</code>
display content of article-name.markdown from git history</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="typ">Renderer</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">revision </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> sha </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"><br />&nbsp; file </span><span class="pun">=</span><span class="pln"> req</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"><br />&nbsp; </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br />&nbsp; <br />&nbsp; posts</span><span class="pun">.</span><span class="pln">revision</span><span class="pun">(</span><span class="pln">sha</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> results</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">render</span><span class="pun">(</span><span class="str">'article.html'</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; article</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; author</span><span class="pun">:</span><span class="pln"> &nbsp;</span><span class="pun">{</span><span class="pln">name</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">.</span><span class="pln">author</span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; headers</span><span class="pun">:</span><span class="pln"> req</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; content</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">.</span><span class="pln">body</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; config</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">options<br />&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-14">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-14">&#182;</a>                </div>                <h3>.feed(req, res, next)</h3>

<p>feed action, called on <code>feed.xml</code>
same as index but rendered using feed.xml template to provide a simple and basic rss feed</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="typ">Renderer</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">feed </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">){</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> abspath </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">options</span><span class="pun">.</span><span class="pln">articleDir</span><span class="pun">].</span><span class="pln">join</span><span class="pun">(</span><span class="str">'/'</span><span class="pun">).</span><span class="pln">replace</span><span class="pun">(</span><span class="str">/\/$/</span><span class="pun">,</span><span class="pln"> </span><span class="str">''</span><span class="pun">),</span><span class="pln"><br />&nbsp; </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br /><br />&nbsp; posts</span><span class="pun">.</span><span class="pln">all</span><span class="pun">(</span><span class="pln">abspath</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> results</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">render</span><span class="pun">(</span><span class="str">'feed.xml'</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">articles</span><span class="pun">:</span><span class="pln"> results</span><span class="pun">,</span><span class="pln"> config</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">options</span><span class="pun">},</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">);</span><span class="pln"><br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; <br />&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">};</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-15">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-15">&#182;</a>                </div>                <h3>.render(target, res, data, force = false)</h3>

<p>convenience method. response is automatically 'sidebarized', meaning that data passed in
will have a special sidebar/has_sidebar properties available to use 
(if a matching _sidebar.markdown is found).</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="typ">Renderer</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">render </span><span class="pun">=</span><span class="pln"> util</span><span class="pun">.</span><span class="pln">sidebarize</span><span class="pun">(</span><span class="kwd">function</span><span class="pln"> render</span><span class="pun">(</span><span class="pln">target</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> force</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; </span><span class="kwd">var</span><span class="pln"> </span><span class="kwd">partial</span><span class="pun">,</span><span class="pln"> layout</span><span class="pun">;</span><span class="pln"><br />&nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-16">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-16">&#182;</a>                </div>                <p>this is where we fire the single response hook, right before templating and response end.</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">emit</span><span class="pun">(</span><span class="str">'yabe.render'</span><span class="pun">,</span><span class="pln"> res</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">);</span><span class="pln"><br />&nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-17">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-17">&#182;</a>                </div>                <p>if any listener have ended the response, prevent default behaviour.</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">res</span><span class="pun">.</span><span class="pln">finished</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="kwd">return</span><span class="pun">;}</span><span class="pln"><br />&nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-18">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-18">&#182;</a>                </div>                <p>force argument when set to true prevent template from being decorated with <code>layout.html</code>
(useful in the case of <code>feed.xml</code>)</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; </span><span class="kwd">partial</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> util</span><span class="pun">.</span><span class="pln">toHtml</span><span class="pun">(</span><span class="str">'tmpl.'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> target</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">);</span><span class="pln"><br />&nbsp; layout </span><span class="pun">=</span><span class="pln"> </span><span class="pun">!</span><span class="pln">force </span><span class="pun">?</span><span class="pln"> util</span><span class="pun">.</span><span class="pln">toHtml</span><span class="pun">(</span><span class="str">'tmpl.layout.html'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">config</span><span class="pun">:</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">config</span><span class="pun">,</span><span class="pln"> context</span><span class="pun">:</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> content</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">partial</span><span class="pun">})</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="kwd">partial</span><span class="pun">;</span><span class="pln"><br />&nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-19">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-19">&#182;</a>                </div>                <p>prettify snippets of code</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; layout </span><span class="pun">=</span><span class="pln"> util</span><span class="pun">.</span><span class="pln">prettify</span><span class="pun">(</span><span class="pln">layout</span><span class="pun">);</span><span class="pln"><br />&nbsp; <br /></span></pre></div>              </td>            </tr>                                  <tr id="section-20">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-20">&#182;</a>                </div>                <p>with feeds, the ' escape made it non valid feed.</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="pln">&nbsp; layout </span><span class="pun">=</span><span class="pln"> layout</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">(</span><span class="str">/ <br />&nbsp; <br />&nbsp; res.writeHead(200, {<br />&nbsp; &nbsp; 'Content-Type': /</span><span class="pun">\.</span><span class="pln">xml</span><span class="pun">/.</span><span class="pln">test</span><span class="pun">(</span><span class="pln">target</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> </span><span class="str">'application/rss+xml'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">'text/html'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="str">'Content-Length'</span><span class="pun">:</span><span class="pln"> layout</span><span class="pun">.</span><span class="pln">length<br />&nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; <br />&nbsp; res</span><span class="pun">.</span><span class="kwd">end</span><span class="pun">(</span><span class="pln">layout</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">});</span><span class="pln"><br /><br /></span></pre></div>              </td>            </tr>                                  <tr id="section-21">              <td class="docs">                <div class="pilwrap">                  <a class="pilcrow" href="#section-21">&#182;</a>                </div>                <p>expose the Renderer Object via</p>              </td>              <td class="code">                <div class="highlight"><pre><span class="kwd">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Renderer</span><span class="pun">(</span><span class="pln">config</span><span class="pun">);</span><span class="pln"><br /></span></pre></div>              </td>            </tr>                  </tbody>      </table>    </div>  </body>  </html>